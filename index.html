<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chromatic Topography - Precision UI</title>
<style>
/* --- PRECISION STACKED UI --- */
body { margin: 0; background: #111; color: #eee; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; }
#app { width: 100%; display: flex; flex-direction: column; height: 100vh; }
canvas { width: 100%; aspect-ratio: 1 / 1; background: #000; display: block; border-bottom: 1px solid #333; }

#controls { 
    width: 100%; 
    background: #121212; 
    padding: 10px; 
    display: flex;
    flex-direction: column; 
    gap: 8px; 
    box-sizing: border-box;
    overflow-y: auto;
}

/* ACTION BUTTONS */
.button-row {
    display: flex;
    gap: 4px;
    width: 100%;
}

.button { 
    background: #2a2a2a; 
    border: 1px solid #444; 
    color: #fff; 
    height: 32px; 
    min-height: 32px; 
    max-height: 32px;
    border-radius: 4px; 
    font-size: 0.7rem; 
    cursor: pointer; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: background 0.2s, border-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
}

/* Only expand buttons inside the top row */
.button-row .button {
    flex: 1;
}

/* Specific style for Download button to ensure full width but fixed height */
#dlBtn {
    width: 100%;
    flex-grow: 0;
}

.button:hover { background: #3a3a3a; border-color: #666; }
/* Active State Class for Toggle Buttons */
.button.active-mode { background: #007bff; border-color: #0056b3; color: white; }

/* SLIDER STYLING */
.slider-wrap {
    width: 100%;
    display: flex;
    flex-direction: column;
    padding: 8px 10px;
    background: #1a1a1a;
    border-radius: 4px;
    box-sizing: border-box;
}

.slider-header {
    display: flex;
    justify-content: space-between; 
    font-size: 0.7rem;
    font-weight: bold;
    color: #bbb;
    margin-bottom: 6px;
    text-transform: uppercase;
}

.slider-header span:last-child { color: #00ffcc; font-family: monospace; }

input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
input[type=range]:focus { outline: none; }
input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }
input[type=range]::-webkit-slider-thumb { height: 14px; width: 14px; border-radius: 50%; background: #007bff; cursor: pointer; -webkit-appearance: none; margin-top: -5px; }

/* TOGGLE ROWS */
.check-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 10px;
    background: #1a1a1a;
    border-radius: 4px;
    font-size: 0.7rem;
}

@media (min-width: 1050px) {
  #app { flex-direction: row; }
  canvas { width: 65vh; height: 65vh; margin: auto; border: none; }
  #controls { width: 400px; height: 100vh; padding: 20px; border-left: 1px solid #333; }
}

#infoModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
.modal-content { background-color: #222; margin: 10% auto; padding: 20px; border: 1px solid #444; width: 80%; max-width: 400px; border-radius: 4px; font-size: 0.8rem; line-height: 1.6; }
.close-modal { background: #007bff; color: white; padding: 4px 12px; border: none; border-radius: 2px; float: right; cursor: pointer; }
ul { padding-left: 20px; margin: 0; }
li { margin-bottom: 8px; color: #ddd; }
</style>
</head>
<body>

<div id="infoModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()">Close</button>
    <h3 style="color:#00ffcc; margin-top:0;">Composition Instructions</h3>
    <ul>
        <li>Click <strong>START</strong> to begin the feed.</li>
        <li>Select <strong>Jagged Little Styll</strong> for noise or <strong>Clifford Bends</strong> for fluid waves.</li>
        <li><strong>Intensity:</strong> Controls the depth of the distortion.</li>
        <li><strong>Expression & Value:</strong> Adjust grid density (X/Y).</li>
        <li><strong>Colour Fields:</strong> Splits the RGB channels.</li>
        <li><strong>Action Painting:</strong> Animates the topography.</li>
        <li>Click <strong>Download PNG</strong> to save your work.</li>
    </ul>
  </div>
</div>

<div id="app">
  <canvas id="canvas"></canvas>
  <div id="controls">
    <div class="button-row">
        <button id="startBtn" class="button">Start</button>
        <button id="cycleBtn" class="button" style="display:none;">Cycle</button>
        <button id="freezeBtn" class="button">Freeze</button>
        <button id="infoBtn" class="button">Info</button>
    </div>
    
    <div class="button-row">
        <button id="jaggedBtn" class="button active-mode">Jagged Little Styll</button>
        <button id="smoothBtn" class="button">Clifford Bends</button>
    </div>

    <div class="slider-wrap">
      <div class="slider-header"><span>Intensity</span><span id="val-rand">20</span></div>
      <input id="randSlider" type="range" min="0" max="100" value="20">
    </div>

    <div class="slider-wrap">
        <div class="slider-header"><span>Abstraction</span><span id="val-freq">3</span></div>
        <input id="freqSlider" type="range" min="1" max="20" value="3" step="0.5">
    </div>

    <div class="slider-wrap">
      <div class="slider-header"><span>Expression</span><span id="val-lines">40</span></div>
      <input id="lineSlider" type="range" min="5" max="100" value="40">
    </div>

    <div class="slider-wrap">
        <div class="slider-header"><span>Value</span><span id="val-nodes">15</span></div>
        <input id="nodeSlider" type="range" min="3" max="60" value="15">
    </div>

    <div class="slider-wrap">
      <div class="slider-header"><span>Colour Fields</span><span id="val-rgb">0.000</span></div>
      <input id="rgbSlider" type="range" min="0" max="50" value="0">
    </div>

    <div class="slider-wrap">
        <div class="slider-header"><span>Dynamism</span><span id="val-speed">5</span></div>
        <input id="speedSlider" type="range" min="1" max="20" value="5">
    </div>

    <div class="check-row">
        <span>Action Painting</span>
        <input id="animateToggle" type="checkbox">
    </div>

    <div class="slider-wrap">
        <div class="slider-header"><span>Toned Ground</span></div>
        <input id="bgColor" type="color" value="#000000" style="height:24px; border:none; width:100%; padding:0; background:none; cursor:pointer;">
    </div>
    
    <button class="button" id="dlBtn" onclick="snapshot()" style="background:#218838; border-color:#1e7e34;">Download PNG</button>
  </div>
</div>

<video id="videoFeed" playsinline autoplay muted style="display:none;"></video>

<script>
const video = document.getElementById('videoFeed');
const canvas = document.getElementById('canvas');
const gl = canvas.getContext('webgl', { preserveDrawingBuffer: true, alpha: true });

let program, positionBuffer, texCoordBuffer, texture;
let rows = 40, cols = 15, randomness = 20, running = false, frozen = false, time = 0;
let isSmooth = false; // False = Jagged, True = Smooth
let videoDevices = [], currentDeviceIndex = 0, staticNoise = [];

const updateText = (id, val) => document.getElementById(id).textContent = val;
document.getElementById('infoBtn').onclick = () => document.getElementById('infoModal').style.display = 'block';
function closeModal() { document.getElementById('infoModal').style.display = 'none'; }

// Mode Button Logic
const jaggedBtn = document.getElementById('jaggedBtn');
const smoothBtn = document.getElementById('smoothBtn');

jaggedBtn.onclick = () => {
    isSmooth = false;
    jaggedBtn.classList.add('active-mode');
    smoothBtn.classList.remove('active-mode');
    if(running) updateMesh();
};

smoothBtn.onclick = () => {
    isSmooth = true;
    smoothBtn.classList.add('active-mode');
    jaggedBtn.classList.remove('active-mode');
    if(running) updateMesh();
};

document.getElementById('randSlider').oninput = (e) => { randomness = e.target.value; updateText('val-rand', randomness); if(running) updateMesh(); };
document.getElementById('freqSlider').oninput = (e) => { updateText('val-freq', e.target.value); if(running) updateMesh(); };
document.getElementById('lineSlider').oninput = (e) => { rows = parseInt(e.target.value); updateText('val-lines', rows); generateStaticNoise(); if(running) updateMesh(); };
document.getElementById('nodeSlider').oninput = (e) => { cols = parseInt(e.target.value); updateText('val-nodes', cols); generateStaticNoise(); if(running) updateMesh(); };
document.getElementById('rgbSlider').oninput = (e) => { updateText('val-rgb', (e.target.value/1000).toFixed(3)); };
document.getElementById('speedSlider').oninput = (e) => { updateText('val-speed', e.target.value); };
document.getElementById('freezeBtn').onclick = () => { frozen = !frozen; document.getElementById('freezeBtn').textContent = frozen ? "Live" : "Freeze"; };

function generateStaticNoise() {
    staticNoise = [];
    for(let r = 0; r <= rows; r++) {
        staticNoise[r] = [];
        for(let c = 0; c <= cols; c++) staticNoise[r][c] = (Math.random() - 0.5);
    }
}

const vs = `attribute vec2 a_pos; attribute vec2 a_texCoord; varying vec2 v_texCoord; void main() { gl_Position = vec4(a_pos, 0, 1); v_texCoord = a_texCoord; }`;
const fs = `precision mediump float; uniform sampler2D u_image; uniform float u_rgbSplit; varying vec2 v_texCoord;
void main() {
    float r = texture2D(u_image, v_texCoord + vec2(u_rgbSplit, 0.0)).r;
    float g = texture2D(u_image, v_texCoord).g;
    float b = texture2D(u_image, v_texCoord - vec2(u_rgbSplit, 0.0)).b;
    gl_FragColor = vec4(r, g, b, 1.0);
}`;

function createShader(gl, type, source) { const s = gl.createShader(type); gl.shaderSource(s, source); gl.compileShader(s); return s; }

function initGL() {
    program = gl.createProgram();
    gl.attachShader(program, createShader(gl, gl.VERTEX_SHADER, vs));
    gl.attachShader(program, createShader(gl, gl.FRAGMENT_SHADER, fs));
    gl.linkProgram(program); gl.useProgram(program);
    positionBuffer = gl.createBuffer(); texCoordBuffer = gl.createBuffer();
    texture = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, texture);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
}

function updateMesh() {
    const positions = [], texCoords = [];
    const warpFactor = randomness / 200;
    const isAnimated = document.getElementById('animateToggle').checked;
    const freq = parseFloat(document.getElementById('freqSlider').value);
    
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            const getPos = (currR, currC) => {
                let x = (currC/cols)*2-1, y = (currR/rows)*2-1;
                
                let displacement = 0;
                
                if (isSmooth) {
                    // Clifford Bends (Smooth Mode)
                    let wave1 = Math.sin(x * freq + (isAnimated ? time : 0));
                    let wave2 = Math.cos(y * freq + (isAnimated ? time * 0.8 : 0));
                    displacement = (wave1 + wave2) * 0.5; 
                } else {
                    // Jagged Little Styll (Noise Mode)
                    displacement = staticNoise[currR][currC] + (isAnimated ? Math.sin(x * 4 + time) * 0.15 : 0);
                }

                let ny = displacement * warpFactor;
                return { x, y: y + ny };
            };
            
            const p1 = getPos(r, c), p2 = getPos(r, c+1), p3 = getPos(r+1, c), p4 = getPos(r+1, c+1);
            const u1 = c/cols, u2 = (c+1)/cols, v1 = 1.0 - (r/rows), v2 = 1.0 - ((r+1)/rows);
            positions.push(p1.x, p1.y, p2.x, p2.y, p3.x, p3.y, p3.x, p3.y, p2.x, p2.y, p4.x, p4.y);
            texCoords.push(u1, v1, u2, v1, u1, v2, u1, v2, u2, v1, u2, v2);
        }
    }
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer); gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.DYNAMIC_DRAW);
    const posLoc = gl.getAttribLocation(program, "a_pos"); gl.enableVertexAttribArray(posLoc); gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
    gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer); gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(texCoords), gl.DYNAMIC_DRAW);
    const texLoc = gl.getAttribLocation(program, "a_texCoord"); gl.enableVertexAttribArray(texLoc); gl.vertexAttribPointer(texLoc, 2, gl.FLOAT, false, 0, 0);
}

async function startCamera() {
    const constraints = { video: { deviceId: videoDevices[currentDeviceIndex]?.deviceId, width: 1024, height: 1024 } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream; await video.play();
    canvas.width = canvas.height = 1024; gl.viewport(0, 0, 1024, 1024);
    if (!program) initGL();
    generateStaticNoise(); updateMesh();
    running = true; loop();
}

async function getDevices() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d => d.kind === 'videoinput');
    if (videoDevices.length > 1) document.getElementById('cycleBtn').style.display = 'flex';
}

function loop() {
    if(!running) return;
    if (document.getElementById('animateToggle').checked) { time += document.getElementById('speedSlider').value / 100; updateMesh(); }
    
    const hex = document.getElementById('bgColor').value;
    const br = parseInt(hex.slice(1,3), 16)/255, bg = parseInt(hex.slice(3,5), 16)/255, bb = parseInt(hex.slice(5,7), 16)/255;

    gl.clearColor(br, bg, bb, 1.0);
    gl.clear(gl.COLOR_BUFFER_BIT);

    gl.uniform1f(gl.getUniformLocation(program, "u_rgbSplit"), document.getElementById('rgbSlider').value / 1000);
    gl.bindTexture(gl.TEXTURE_2D, texture);
    if (!frozen) gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);
    gl.drawArrays(gl.TRIANGLES, 0, rows * cols * 6);
    requestAnimationFrame(loop);
}

document.getElementById('startBtn').onclick = () => { getDevices().then(startCamera); };
document.getElementById('cycleBtn').onclick = () => { currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length; startCamera(); };
function snapshot() { const link = document.createElement('a'); link.download = `Warp-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); }
</script>
</body>
</html>
