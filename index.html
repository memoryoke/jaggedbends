<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Jagged Bends</title>
<style>
/* --- BASE STYLES --- */
body {
  margin: 0;
  background: #111;
  color: #eee;
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  /* Mobile Default: 1.5x larger */
  font-size: 1.15rem; 
}

#app { width: 100%; display: flex; flex-direction: column; }

canvas {
  width: 100%;
  aspect-ratio: 1 / 1;
  background: #000;
  display: block;
}

/* --- CONTROLS GRID --- */
#controls {
  width: 100%;
  background: #1a1a1a;
  padding: 1.2rem;
  display: grid;
  grid-template-columns: repeat(4, 1fr);  
  gap: 0.8rem;
  box-sizing: border-box;
}

/* UI ELEMENTS (Mobile Scale) */
.button {
  background: #333;
  border: 1px solid #444;
  color: #fff;
  padding: 1rem 0.4rem;
  border-radius: 8px;
  font-size: 1.1rem;
  cursor: pointer;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  text-transform: uppercase;
  font-weight: bold;
  transition: all 0.2s;
}

.button.active-mode { background: #007bff; border-color: #00a2ff; }

.slider-wrap, .control-row {
  grid-column: span 4;
  background: #222;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #333;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.control-row { flex-direction: row; justify-content: space-between; align-items: center; }
.slider-header { display: flex; justify-content: space-between; color: #aaa; text-transform: uppercase; }
.slider-header span:last-child { color: #00ffcc; font-family: monospace; }

/* Desktop Scaling (Reverted to original compact size) */
@media (min-width: 1050px) {
  body { font-size: 0.85rem; justify-content: center; padding: 20px; }
  #app { max-width: 1100px; flex-direction: row; align-items: flex-start; gap: 20px; }
  canvas { width: 550px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
  #controls { flex: 1; border-radius: 8px; padding: 1rem; gap: 0.6rem; }
  .button { padding: 0.8rem 0.2rem; font-size: 0.85rem; border-radius: 6px; }
  .slider-wrap, .control-row { padding: 10px; border-radius: 4px; font-size: 0.75rem; }
}

.span-1 { grid-column: span 1; }
.span-2 { grid-column: span 2; }
.span-4 { grid-column: span 4; }

#infoModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
.modal-content { background: #222; margin: 10% auto; padding: 30px; width: 80%; max-width: 500px; border-radius: 12px; }
</style>
</head>
<body>

<div id="infoModal">
  <div class="modal-content">
    <button style="float:right;" onclick="closeModal()">Close</button>
    <h3 style="color:#00ffcc;">Jagged Bends Instructions</h3>
    <ul>
        <li><strong>Start:</strong> Initialize feed.</li>
        <li><strong>Switch:</strong> Cycle through available cameras.</li>
        <li><strong>Modes:</strong> Jagged (Noise) vs Clifford (Fluid).</li>
        <li><strong>Download:</strong> Captures at high-fidelity 1024px.</li>
    </ul>
  </div>
</div>

<div id="app">
  <canvas id="canvas"></canvas>

  <div id="controls">
    <button id="startBtn" class="button span-1">Start</button>
    <button id="switchBtn" class="button span-1" style="display:none;">Switch</button>
    <button id="freezeBtn" class="button span-1">Freeze</button>
    <button id="infoBtn" class="button span-1" style="background: #555;">Info</button>

    <button id="jaggedBtn" class="button span-2 active-mode">Jagged Little Styll</button>
    <button id="smoothBtn" class="button span-2">Clifford Bends</button>

    <div class="slider-wrap">
      <div class="slider-header"><span>Intensity</span><span id="val-rand">20</span></div>
      <input id="randSlider" type="range" min="0" max="100" value="20">
    </div>

    <div class="slider-wrap">
       <div class="slider-header"><span>Abstraction</span><span id="val-freq">3</span></div>
       <input id="freqSlider" type="range" min="1" max="20" value="3" step="0.5">
    </div>

    <div class="slider-wrap">
      <div class="slider-header"><span>Expression</span><span id="val-lines">40</span></div>
      <input id="lineSlider" type="range" min="5" max="100" value="40">
    </div>

    <div class="slider-wrap">
       <div class="slider-header"><span>Value</span><span id="val-nodes">15</span></div>
       <input id="nodeSlider" type="range" min="3" max="60" value="15">
    </div>

    <div class="slider-wrap">
      <div class="slider-header"><span>Colour Fields</span><span id="val-rgb">0.000</span></div>
      <input id="rgbSlider" type="range" min="0" max="50" value="0">
    </div>

    <div class="slider-wrap">
       <div class="slider-header"><span>Dynamism</span><span id="val-speed">5</span></div>
       <input id="speedSlider" type="range" min="1" max="20" value="5">
    </div>

    <div class="control-row">
        <span>Action Painting</span>
        <input id="animateToggle" type="checkbox" style="transform: scale(1.5);">
    </div>

    <div class="control-row">
        <span>Toned Ground</span>
        <input id="bgColor" type="color" value="#000000">
    </div>
    
    <button class="button span-4" id="dlBtn" onclick="snapshot()" style="background:#28a745; border-color: #1e7e34; margin-top: 5px;">Download PNG</button>
  </div>
</div>

<video id="videoFeed" playsinline autoplay muted style="display:none;"></video>

<script>
const video = document.getElementById('videoFeed');
const canvas = document.getElementById('canvas');
const gl = canvas.getContext('webgl', { preserveDrawingBuffer: true, alpha: true });

let program, positionBuffer, texCoordBuffer, texture;
let rows = 40, cols = 15, randomness = 20, running = false, frozen = false, time = 0;
let isSmooth = false;
let videoDevices = [], currentDeviceIndex = 0, staticNoise = [];

const updateText = (id, val) => document.getElementById(id).textContent = val;
document.getElementById('infoBtn').onclick = () => document.getElementById('infoModal').style.display = 'block';
function closeModal() { document.getElementById('infoModal').style.display = 'none'; }

document.getElementById('jaggedBtn').onclick = () => {
    isSmooth = false;
    document.getElementById('jaggedBtn').classList.add('active-mode');
    document.getElementById('smoothBtn').classList.remove('active-mode');
    if(running) updateMesh();
};

document.getElementById('smoothBtn').onclick = () => {
    isSmooth = true;
    document.getElementById('smoothBtn').classList.add('active-mode');
    document.getElementById('jaggedBtn').classList.remove('active-mode');
    if(running) updateMesh();
};

document.getElementById('randSlider').oninput = (e) => { randomness = e.target.value; updateText('val-rand', randomness); if(running) updateMesh(); };
document.getElementById('freqSlider').oninput = (e) => { updateText('val-freq', e.target.value); if(running) updateMesh(); };
document.getElementById('lineSlider').oninput = (e) => { rows = parseInt(e.target.value); updateText('val-lines', rows); generateStaticNoise(); if(running) updateMesh(); };
document.getElementById('nodeSlider').oninput = (e) => { cols = parseInt(e.target.value); updateText('val-nodes', cols); generateStaticNoise(); if(running) updateMesh(); };
document.getElementById('rgbSlider').oninput = (e) => { updateText('val-rgb', (e.target.value/1000).toFixed(3)); };
document.getElementById('speedSlider').oninput = (e) => { updateText('val-speed', e.target.value); };
document.getElementById('freezeBtn').onclick = () => { 
    frozen = !frozen; 
    document.getElementById('freezeBtn').classList.toggle('active-mode', frozen);
};

function generateStaticNoise() {
    staticNoise = [];
    for(let r = 0; r <= rows; r++) {
        staticNoise[r] = [];
        for(let c = 0; c <= cols; c++) staticNoise[r][c] = (Math.random() - 0.5);
    }
}

const vs = `attribute vec2 a_pos; attribute vec2 a_texCoord; varying vec2 v_texCoord; void main() { gl_Position = vec4(a_pos, 0, 1); v_texCoord = a_texCoord; }`;
const fs = `precision mediump float; uniform sampler2D u_image; uniform float u_rgbSplit; varying vec2 v_texCoord;
void main() {
    float r = texture2D(u_image, v_texCoord + vec2(u_rgbSplit, 0.0)).r;
    float g = texture2D(u_image, v_texCoord).g;
    float b = texture2D(u_image, v_texCoord - vec2(u_rgbSplit, 0.0)).b;
    gl_FragColor = vec4(r, g, b, 1.0);
}`;

function createShader(gl, type, source) { const s = gl.createShader(type); gl.shaderSource(s, source); gl.compileShader(s); return s; }

function initGL() {
    program = gl.createProgram();
    gl.attachShader(program, createShader(gl, gl.VERTEX_SHADER, vs));
    gl.attachShader(program, createShader(gl, gl.FRAGMENT_SHADER, fs));
    gl.linkProgram(program); gl.useProgram(program);
    positionBuffer = gl.createBuffer(); texCoordBuffer = gl.createBuffer();
    texture = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, texture);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
}

function updateMesh() {
    const positions = [], texCoords = [];
    const warpFactor = randomness / 200;
    const isAnimated = document.getElementById('animateToggle').checked;
    const freq = parseFloat(document.getElementById('freqSlider').value);
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            const getPos = (currR, currC) => {
                let x = (currC/cols)*2-1, y = (currR/rows)*2-1;
                let displacement = isSmooth ? (Math.sin(x * freq + (isAnimated ? time : 0)) + Math.cos(y * freq + (isAnimated ? time * 0.8 : 0))) * 0.5 : staticNoise[currR][currC] + (isAnimated ? Math.sin(x * 4 + time) * 0.15 : 0);
                return { x, y: y + (displacement * warpFactor) };
            };
            const p1 = getPos(r, c), p2 = getPos(r, c+1), p3 = getPos(r+1, c), p4 = getPos(r+1, c+1);
            const u1 = c/cols, u2 = (c+1)/cols, v1 = 1.0 - (r/rows), v2 = 1.0 - ((r+1)/rows);
            positions.push(p1.x, p1.y, p2.x, p2.y, p3.x, p3.y, p3.x, p3.y, p2.x, p2.y, p4.x, p4.y);
            texCoords.push(u1, v1, u2, v1, u1, v2, u1, v2, u2, v1, u2, v2);
        }
    }
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer); gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.DYNAMIC_DRAW);
    const posLoc = gl.getAttribLocation(program, "a_pos"); gl.enableVertexAttribArray(posLoc); gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
    gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer); gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(texCoords), gl.DYNAMIC_DRAW);
    const texLoc = gl.getAttribLocation(program, "a_texCoord"); gl.enableVertexAttribArray(texLoc); gl.vertexAttribPointer(texLoc, 2, gl.FLOAT, false, 0, 0);
}

function stopCurrentStream() { if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop()); }

async function startCamera() {
    stopCurrentStream();
    try {
        const constraints = { video: { deviceId: videoDevices[currentDeviceIndex]?.deviceId ? { exact: videoDevices[currentDeviceIndex].deviceId } : undefined, width: 1024, height: 1024 } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream; await video.play();
        canvas.width = canvas.height = 1024; gl.viewport(0, 0, 1024, 1024);
        if (!program) initGL();
        generateStaticNoise(); updateMesh();
        if (!running) { running = true; loop(); }
    } catch (e) { alert("Camera Error: " + e.message); }
}

async function getDevices() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d => d.kind === 'videoinput');
    if (videoDevices.length > 1) document.getElementById('switchBtn').style.display = 'flex';
}

function loop() {
    if(!running) return;
    if (document.getElementById('animateToggle').checked) { time += document.getElementById('speedSlider').value / 100; updateMesh(); }
    const hex = document.getElementById('bgColor').value;
    const br = parseInt(hex.slice(1,3), 16)/255, bg = parseInt(hex.slice(3,5), 16)/255, bb = parseInt(hex.slice(5,7), 16)/255;
    gl.clearColor(br, bg, bb, 1.0); gl.clear(gl.COLOR_BUFFER_BIT);
    gl.uniform1f(gl.getUniformLocation(program, "u_rgbSplit"), document.getElementById('rgbSlider').value / 1000);
    gl.bindTexture(gl.TEXTURE_2D, texture);
    if (!frozen) gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);
    gl.drawArrays(gl.TRIANGLES, 0, rows * cols * 6);
    requestAnimationFrame(loop);
}

document.getElementById('startBtn').onclick = () => { getDevices().then(startCamera); };
document.getElementById('switchBtn').onclick = () => { currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length; startCamera(); };
function snapshot() { const link = document.createElement('a'); link.download = `Jagged-Bends-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); }
getDevices();
</script>
</body>
</html>
